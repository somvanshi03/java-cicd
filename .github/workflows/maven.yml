name: Build Selected Microservices

on:
  workflow_dispatch:
    inputs:
      service_names:
        description: 'Comma-separated microservices to build (e.g., api-gateway,car-service,discovery-service)'
        required: true
        type: string
      java_version:
        description: 'Java version (e.g., 17 or 21)'
        required: true
        type: choice
        options:
          - '17'
          - '21'

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      services_json: ${{ steps.build-matrix.outputs.services_json }}
    steps:
      - name: Build matrix JSON from input
        id: build-matrix
        run: |
          # Normalize: remove spaces, to lowercase
          RAW="${{ github.event.inputs.service_names }}"
          NORMALIZED=$(echo "$RAW" | tr -d ' ' | tr '[:upper:]' '[:lower:]')
          # Validate allowed values
          IFS=',' read -ra ARR <<< "$NORMALIZED"
          VALID=("api-gateway" "car-service" "discovery-service")
          FILTERED=()
          for svc in "${ARR[@]}"; do
            for v in "${VALID[@]}"; do
              if [ "$svc" = "$v" ]; then
                FILTERED+=("$svc")
              fi
            done
          done
          if [ ${#FILTERED[@]} -eq 0 ]; then
            echo "No valid services selected. Allowed: api-gateway, car-service, discovery-service"
            exit 1
          fi
          # Emit JSON array for matrix
          printf -v JSON '[%s]' "$(printf '"%s",' "${FILTERED[@]}" | sed 's/,$//')"
          echo "services_json=$JSON" >> $GITHUB_OUTPUT
          echo "Matrix: $JSON"

  build:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.prepare-matrix.outputs.services_json) }}

    env:
      SERVICE_DIR: ${{ matrix.service }}
      JAVA_VERSION: ${{ github.event.inputs.java_version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate service directory exists
        run: |
          if [ ! -d "${{ env.SERVICE_DIR }}" ]; then
            echo "Service directory not found: ${{ env.SERVICE_DIR }}"
            exit 1
          fi
          echo "Building: ${{ env.SERVICE_DIR }} with Java ${{ env.JAVA_VERSION }}"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Build with Maven
        working-directory: ${{ env.SERVICE_DIR }}
        run: mvn -B -ntp -DskipTests=false clean verify

      # Optional: upload per-service JAR artifact
      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-jar
          path: ${{ env.SERVICE_DIR }}/target/*.jar
