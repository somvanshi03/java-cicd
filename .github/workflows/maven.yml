---
name: Build Selected Microservices
on:
  workflow_dispatch:
    inputs:
      build_api_gateway:
        description: Build api-gateway
        type: boolean
        required: true
        default: true
      build_car_service:
        description: Build car-service
        type: boolean
        required: true
        default: false
      build_discovery_service:
        description: Build discovery-service
        type: boolean
        required: true
        default: false
      java_version:
        description: Java version (e.g., 17 or 21)
        required: true
        type: choice
        options:
          - "17"
          - "21"
jobs:
  prepare-matrix:
    name: Prepare matrix from checkboxes
    runs-on: ubuntu-latest
    outputs:
      services_json: ${{ steps.build.outputs.services_json }}
    steps:
      - name: Compute selected services JSON
        id: build
        run: >
          SELECTED=()

          if [ "${{ github.event.inputs.build_api_gateway }}" = "true" ]; then
            SELECTED+=("api-gateway")
          fi

          if [ "${{ github.event.inputs.build_car_service }}" = "true" ]; then
            SELECTED+=("car-service")
          fi

          if [ "${{ github.event.inputs.build_discovery_service }}" = "true" ]; then
            SELECTED+=("discovery-service")
          fi


          if [ ${#SELECTED[@]} -eq 0 ]; then
            echo "No services selected. Choose at least one checkbox."
            exit 1
          fi


          printf -v JSON '[%s]' "$(printf '"%s",' "${SELECTED[@]}" | sed 's/,$//')"

          echo "services_json=$JSON" >> $GITHUB_OUTPUT

          echo "Matrix: $JSON"
  build:
    name: Build selected services
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.prepare-matrix.outputs.services_json) }}
    env:
      SERVICE_DIR: ${{ matrix.service }}
      JAVA_VERSION: ${{ github.event.inputs.java_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Validate service directory exists
        run: >
          if [ ! -d "${{ env.SERVICE_DIR }}" ]; then
            echo "Service directory not found: ${{ env.SERVICE_DIR }}"
            exit 1
          fi

          echo "Building: ${{ env.SERVICE_DIR }} with Java ${{ env.JAVA_VERSION }}"
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven
      - name: Build with Maven
        working-directory: ${{ env.SERVICE_DIR }}
        run: mvn -B -ntp -DskipTests=false clean verify
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-jar
          path: ${{ env.SERVICE_DIR }}/target/*.jar
      - name: Build Docker image
        run: >
          docker build -t ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:${{ steps.meta.outputs.build_tag }}
