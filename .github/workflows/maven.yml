name: Build Selected Microservices

on:
  workflow_dispatch:
    inputs:
      service_names:
        description: 'Comma-separated microservices to build (e.g., api-gateway,car-service,discovery-service)'
        required: true
        type: string
      java_version:
        description: 'Java version (e.g., 17 or 21)'
        required: true
        type: choice
        options:
          - '17'
          - '21'

permissions:
  contents: read
  packages: write

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      services_json: ${{ steps.build-matrix.outputs.services_json }}
    steps:
      - name: Build matrix JSON from input
        id: build-matrix
        run: |
          # Normalize: remove spaces, to lowercase
          RAW="${{ github.event.inputs.service_names }}"
          NORMALIZED=$(echo "$RAW" | tr -d ' ' | tr '[:upper:]' '[:lower:]')

          # Validate allowed values
          IFS=',' read -ra ARR <<< "$NORMALIZED"
          VALID=("api-gateway" "car-service" "discovery-service")
          FILTERED=()
          for svc in "${ARR[@]}"; do
            for v in "${VALID[@]}"; do
              if [ "$svc" = "$v" ]; then
                FILTERED+=("$svc")
              fi
            done
          done
          if [ ${#FILTERED[@]} -eq 0 ]; then
            echo "No valid services selected. Allowed: api-gateway, car-service, discovery-service"
            exit 1
          fi

          # Emit JSON array for matrix
          printf -v JSON '[%s]' "$(printf '"%s",' "${FILTERED[@]}" | sed 's/,$//')"
          echo "services_json=$JSON" >> $GITHUB_OUTPUT
          echo "Matrix: $JSON"

  build:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.prepare-matrix.outputs.services_json) }}

    env:
      SERVICE_DIR: ${{ matrix.service }}
      JAVA_VERSION: ${{ github.event.inputs.java_version }}
      REGISTRY: ghcr.io
      OWNER: ${{ github.repository_owner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate service directory exists
        run: |
          if [ ! -d "${{ env.SERVICE_DIR }}" ]; then
            echo "Service directory not found: ${{ env.SERVICE_DIR }}"
            exit 1
          fi
          echo "Building: ${{ env.SERVICE_DIR }} with Java ${{ env.JAVA_VERSION }}"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Build with Maven
        working-directory: ${{ env.SERVICE_DIR }}
        run: mvn -B -ntp -DskipTests=false clean verify

      # ---- Docker build & push to GHCR ----
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image name & tags
        id: meta
        run: |
          # Image: ghcr.io/<owner>/<service>
          IMAGE="${{ env.REGISTRY }}/${{ env.OWNER }}/${{ matrix.service }}"
          SHA_TAG="${IMAGE}:${{ github.sha }}"
          JAVA_TAG="${IMAGE}:java-${{ env.JAVA_VERSION }}"
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "sha_tag=${SHA_TAG}" >> $GITHUB_OUTPUT
          echo "java_tag=${JAVA_TAG}" >> $GITHUB_OUTPUT
          # latest only on main
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "latest_tag=${IMAGE}:latest" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image
        run: |
          docker build \
            -f "${{ env.SERVICE_DIR }}/Dockerfile" \
            -t "${{ steps.meta.outputs.sha_tag }}" \
            -t "${{ steps.meta.outputs.java_tag }}" \
            ${{ steps.meta.outputs.latest_tag && format('-t {0}', steps.meta.outputs.latest_tag) || '' }} \
            "${{ env.SERVICE_DIR }}"
